# TASK-20250905-1858-03: API Gateway 설정 및 연동

## 작업 정보
- **작업 ID**: TASK-20250905-1858-03
- **제목**: API Gateway 설정 및 연동
- **담당자**: 풍기덕
- **할당자**: 백승재
- **우선순위**: HIGH
- **상태**: TODO
- **예상 시간**: 1.5시간
- **생성일**: 2025-09-05 18:58
- **마감일**: 2025-09-06 12:00

## 작업 목표
Lambda 함수들과 연동되는 API Gateway를 Terraform으로 설정 및 배포

## 상세 작업 내용

### 1. API Gateway REST API 생성
**참고 문서**: `planning/design/architecture/API명세서.md`

```hcl
resource "aws_api_gateway_rest_api" "gmp_checkmaster_api" {
  name        = "gmp-checkmaster-api"
  description = "GMP CheckMaster AI API Gateway"
  
  endpoint_configuration {
    types = ["REGIONAL"]
  }
}
```

### 2. API Gateway 리소스 및 메서드 설정

#### 🔐 **인증 API (/auth)**
```hcl
# /auth 리소스
resource "aws_api_gateway_resource" "auth" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  path_part   = "auth"
}

# POST /auth/login
resource "aws_api_gateway_method" "auth_login" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_resource.auth.id
  http_method   = "POST"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "auth_login" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_resource.auth.id
  http_method = aws_api_gateway_method.auth_login.http_method
  
  integration_http_method = "POST"
  type                   = "AWS_PROXY"
  uri                    = aws_lambda_function.auth_handler.invoke_arn
}
```

#### 📋 **체크리스트 API (/checklists)**
```hcl
# /checklists 리소스
resource "aws_api_gateway_resource" "checklists" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  path_part   = "checklists"
}

# GET /checklists/templates
resource "aws_api_gateway_resource" "checklist_templates" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_resource.checklists.id
  path_part   = "templates"
}

resource "aws_api_gateway_method" "get_templates" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_resource.checklist_templates.id
  http_method   = "GET"
  authorization = "NONE"  # 해커톤용 간소화
}

resource "aws_api_gateway_integration" "get_templates" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_resource.checklist_templates.id
  http_method = aws_api_gateway_method.get_templates.http_method
  
  integration_http_method = "POST"
  type                   = "AWS_PROXY"
  uri                    = aws_lambda_function.checklist_handler.invoke_arn
}

# POST /checklists/submit
resource "aws_api_gateway_resource" "checklist_submit" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_resource.checklists.id
  path_part   = "submit"
}

resource "aws_api_gateway_method" "submit_checklist" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_resource.checklist_submit.id
  http_method   = "POST"
  authorization = "NONE"  # 해커톤용 간소화
}

resource "aws_api_gateway_integration" "submit_checklist" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_resource.checklist_submit.id
  http_method = aws_api_gateway_method.submit_checklist.http_method
  
  integration_http_method = "POST"
  type                   = "AWS_PROXY"
  uri                    = aws_lambda_function.checklist_handler.invoke_arn
}
```

#### 🤖 **AI 판정 API (/ai)**
```hcl
# /ai 리소스
resource "aws_api_gateway_resource" "ai" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  path_part   = "ai"
}

# POST /ai/judge
resource "aws_api_gateway_resource" "ai_judge" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_resource.ai.id
  path_part   = "judge"
}

resource "aws_api_gateway_method" "ai_judge" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_resource.ai_judge.id
  http_method   = "POST"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "ai_judge" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_resource.ai_judge.id
  http_method = aws_api_gateway_method.ai_judge.http_method
  
  integration_http_method = "POST"
  type                   = "AWS_PROXY"
  uri                    = aws_lambda_function.ai_judgment_handler.invoke_arn
}
```

#### 📱 **QR 코드 API (/qr)**
```hcl
# /qr 리소스
resource "aws_api_gateway_resource" "qr" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  path_part   = "qr"
}

# POST /qr/generate
resource "aws_api_gateway_resource" "qr_generate" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  parent_id   = aws_api_gateway_resource.qr.id
  path_part   = "generate"
}

resource "aws_api_gateway_method" "qr_generate" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_resource.qr_generate.id
  http_method   = "POST"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "qr_generate" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_resource.qr_generate.id
  http_method = aws_api_gateway_method.qr_generate.http_method
  
  integration_http_method = "POST"
  type                   = "AWS_PROXY"
  uri                    = aws_lambda_function.qr_handler.invoke_arn
}
```

### 3. CORS 설정
```hcl
resource "aws_api_gateway_method" "options_cors" {
  rest_api_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id   = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  http_method   = "OPTIONS"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "options_cors" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  http_method = aws_api_gateway_method.options_cors.http_method
  type        = "MOCK"
  
  request_templates = {
    "application/json" = "{\"statusCode\": 200}"
  }
}

resource "aws_api_gateway_method_response" "options_cors" {
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  resource_id = aws_api_gateway_rest_api.gmp_checkmaster_api.root_resource_id
  http_method = aws_api_gateway_method.options_cors.http_method
  status_code = "200"
  
  response_parameters = {
    "method.response.header.Access-Control-Allow-Headers" = true
    "method.response.header.Access-Control-Allow-Methods" = true
    "method.response.header.Access-Control-Allow-Origin"  = true
  }
}
```

### 4. API Gateway 배포
```hcl
resource "aws_api_gateway_deployment" "gmp_checkmaster_deployment" {
  depends_on = [
    aws_api_gateway_integration.auth_login,
    aws_api_gateway_integration.get_templates,
    aws_api_gateway_integration.submit_checklist,
    aws_api_gateway_integration.ai_judge,
    aws_api_gateway_integration.qr_generate
  ]
  
  rest_api_id = aws_api_gateway_rest_api.gmp_checkmaster_api.id
  stage_name  = "dev"
}
```

### 5. Lambda 권한 설정
```hcl
resource "aws_lambda_permission" "api_gateway_auth" {
  statement_id  = "AllowExecutionFromAPIGateway"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.auth_handler.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_api_gateway_rest_api.gmp_checkmaster_api.execution_arn}/*/*"
}

# 다른 Lambda 함수들도 동일하게 설정...
```

## 수용 기준
- [ ] API Gateway REST API 생성 완료
- [ ] 주요 엔드포인트 5개 설정 완료 (/auth, /checklists, /ai, /qr, /dashboard)
- [ ] Lambda 함수 연동 완료
- [ ] CORS 설정 완료
- [ ] API Gateway 배포 완료 (dev 스테이지)
- [ ] API 엔드포인트 테스트 (기본 응답 확인)

## 참고 자료
- `planning/design/architecture/API명세서.md`
- `planning/design/architecture/시스템아키텍처.md`

## 의존성
- **선행 작업**: TASK-20250905-1858-02 (Lambda 함수 배포)
- **후속 작업**: 프론트엔드 배포 (TASK-20250905-1858-04)

## 위험 요소
- API Gateway 설정 복잡성
- Lambda 권한 설정 오류
- CORS 설정 누락

---
**생성일**: 2025-09-05 18:58  
**담당자**: 풍기덕  
**상태**: TODO
