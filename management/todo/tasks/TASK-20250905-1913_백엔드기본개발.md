# TASK-20250905-1913: 백엔드 기본 구조 및 Lambda 함수 개발

## 작업 정보
- **작업 ID**: TASK-20250905-1913
- **제목**: 백엔드 기본 구조 및 Lambda 함수 개발
- **담당자**: 백승재
- **할당자**: 백승재
- **우선순위**: HIGH
- **상태**: TODO
- **예상 시간**: 3시간
- **생성일**: 2025-09-05 19:13
- **마감일**: 2025-09-06 09:00

## 작업 목표
SAM 템플릿 기반 Lambda 함수 5개 기본 구조 생성 및 핵심 API 구현

## 상세 작업 내용

### 1. 프로젝트 구조 생성
```
development/backend/
├── template.yaml              # SAM 템플릿
├── lambda/
│   ├── auth-handler/
│   │   ├── index.js
│   │   └── package.json
│   ├── checklist-handler/
│   │   ├── index.js
│   │   └── package.json
│   ├── ai-judgment-handler/
│   │   ├── index.js
│   │   └── package.json
│   ├── qr-handler/
│   │   ├── index.js
│   │   └── package.json
│   └── dashboard-handler/
│       ├── index.js
│       └── package.json
├── shared/
│   ├── response-utils.js      # 공통 응답 유틸
│   ├── auth-utils.js          # 인증 유틸
│   └── mock-data.js           # 해커톤용 Mock 데이터
├── events/                    # 테스트 이벤트
│   ├── login.json
│   ├── get-templates.json
│   ├── submit-checklist.json
│   ├── ai-judge.json
│   └── generate-qr.json
└── scripts/
    └── dev-start.sh           # 로컬 개발 시작 스크립트
```

### 2. SAM 템플릿 작성
```yaml
# template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 30
    MemorySize: 256
    Environment:
      Variables:
        NODE_ENV: development
        CORS_ORIGIN: "*"

Resources:
  # 인증 핸들러
  AuthHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/auth-handler/
      Handler: index.handler
      Events:
        LoginApi:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post
        LogoutApi:
          Type: Api
          Properties:
            Path: /auth/logout
            Method: post

  # 체크리스트 핸들러
  ChecklistHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/checklist-handler/
      Handler: index.handler
      Events:
        GetTemplates:
          Type: Api
          Properties:
            Path: /checklists/templates
            Method: get
        SubmitChecklist:
          Type: Api
          Properties:
            Path: /checklists/submit
            Method: post
        GetRecords:
          Type: Api
          Properties:
            Path: /checklists/records
            Method: get

  # AI 판정 핸들러
  AIJudgmentHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/ai-judgment-handler/
      Handler: index.handler
      MemorySize: 512
      Events:
        JudgeApi:
          Type: Api
          Properties:
            Path: /ai/judge
            Method: post

  # QR 코드 핸들러
  QRHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/qr-handler/
      Handler: index.handler
      Events:
        GenerateQR:
          Type: Api
          Properties:
            Path: /qr/generate
            Method: post
        VerifyQR:
          Type: Api
          Properties:
            Path: /qr/verify
            Method: post

  # 대시보드 핸들러
  DashboardHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/dashboard-handler/
      Handler: index.handler
      Events:
        GetStats:
          Type: Api
          Properties:
            Path: /dashboard/stats
            Method: get
        GetReports:
          Type: Api
          Properties:
            Path: /dashboard/reports
            Method: get

Outputs:
  ApiGatewayEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
```

### 3. 공통 유틸리티 작성

#### shared/response-utils.js
```javascript
// 표준 응답 형식
const createResponse = (statusCode, data, message = null) => {
  return {
    statusCode,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      success: statusCode < 400,
      data,
      message,
      timestamp: new Date().toISOString()
    })
  };
};

const successResponse = (data, message = 'Success') => createResponse(200, data, message);
const errorResponse = (statusCode, message, data = null) => createResponse(statusCode, data, message);

module.exports = { createResponse, successResponse, errorResponse };
```

#### shared/mock-data.js
```javascript
// 해커톤용 Mock 데이터
const DEMO_USERS = {
  'worker1': { id: 'worker1', name: '김작업', role: 'worker', team: '생산팀A' },
  'operator1': { id: 'operator1', name: '박운영', role: 'operator', team: '운영팀' },
  'supervisor1': { id: 'supervisor1', name: '이책임', role: 'supervisor', team: '생산팀A' },
  'admin1': { id: 'admin1', name: '최관리', role: 'admin', team: 'IT팀' },
  'security1': { id: 'security1', name: '정보안', role: 'security', team: '보안팀' }
};

const HYGIENE_TEMPLATE = {
  template_id: 'hygiene_checklist',
  name: '위생상태점검표',
  type: 'hygiene',
  items: [
    { id: 'symptoms', question: '발열, 설사, 구토 증상이 있나요?', type: 'select', options: ['없음', '있음'] },
    { id: 'respiratory', question: '호흡기 질환은 없나요?', type: 'select', options: ['없음', '있음'] },
    { id: 'wound', question: '신체에 상처가 있나요?', type: 'select', options: ['없음', '있음'] },
    { id: 'clothing', question: '작업복 착용이 적절한가요?', type: 'select', options: ['적절', '부적절'] },
    { id: 'accessories', question: '장신구를 제거했나요?', type: 'select', options: ['제거함', '착용중'] },
    { id: 'hair', question: '두발 상태가 적절한가요?', type: 'select', options: ['적절', '부적절'] },
    { id: 'nails', question: '손톱이 깨끗하고 짧은가요?', type: 'select', options: ['적절', '부적절'] },
    { id: 'makeup', question: '화장을 하지 않았나요?', type: 'select', options: ['안함', '함'] },
    { id: 'personal_items', question: '개인 물품을 반입하지 않았나요?', type: 'select', options: ['반입안함', '반입함'] }
  ]
};

module.exports = { DEMO_USERS, HYGIENE_TEMPLATE };
```

### 4. Lambda 함수 구현

#### lambda/auth-handler/index.js
```javascript
const { successResponse, errorResponse } = require('../../shared/response-utils');
const { DEMO_USERS } = require('../../shared/mock-data');

exports.handler = async (event) => {
  try {
    console.log('Auth Event:', JSON.stringify(event, null, 2));
    
    const path = event.path;
    const method = event.httpMethod;
    
    if (path === '/auth/login' && method === 'POST') {
      return await handleLogin(event);
    }
    
    if (path === '/auth/logout' && method === 'POST') {
      return await handleLogout(event);
    }
    
    return errorResponse(404, 'Not Found');
    
  } catch (error) {
    console.error('Auth Error:', error);
    return errorResponse(500, 'Internal Server Error');
  }
};

async function handleLogin(event) {
  const { user_id, password } = JSON.parse(event.body);
  
  if (DEMO_USERS[user_id]) {
    return successResponse({
      token: `demo-jwt-${user_id}-${Date.now()}`,
      user: DEMO_USERS[user_id]
    }, 'Login successful');
  }
  
  return errorResponse(401, 'Invalid credentials');
}

async function handleLogout(event) {
  return successResponse(null, 'Logout successful');
}
```

#### lambda/checklist-handler/index.js
```javascript
const { successResponse, errorResponse } = require('../../shared/response-utils');
const { HYGIENE_TEMPLATE } = require('../../shared/mock-data');

exports.handler = async (event) => {
  try {
    console.log('Checklist Event:', JSON.stringify(event, null, 2));
    
    const path = event.path;
    const method = event.httpMethod;
    
    if (path === '/checklists/templates' && method === 'GET') {
      return await getTemplates(event);
    }
    
    if (path === '/checklists/submit' && method === 'POST') {
      return await submitChecklist(event);
    }
    
    if (path === '/checklists/records' && method === 'GET') {
      return await getRecords(event);
    }
    
    return errorResponse(404, 'Not Found');
    
  } catch (error) {
    console.error('Checklist Error:', error);
    return errorResponse(500, 'Internal Server Error');
  }
};

async function getTemplates(event) {
  return successResponse([HYGIENE_TEMPLATE], 'Templates retrieved');
}

async function submitChecklist(event) {
  const data = JSON.parse(event.body);
  
  // Mock 저장 (실제로는 DynamoDB에 저장)
  const record = {
    record_id: `record_${Date.now()}`,
    user_id: data.user_id,
    template_id: data.template_id,
    responses: data.responses,
    submitted_at: new Date().toISOString(),
    status: 'pending'
  };
  
  return successResponse(record, 'Checklist submitted');
}

async function getRecords(event) {
  // Mock 데이터 반환
  const records = [
    {
      record_id: 'record_1',
      user_id: 'worker1',
      template_id: 'hygiene_checklist',
      status: 'approved',
      submitted_at: '2025-09-05T10:00:00Z'
    }
  ];
  
  return successResponse(records, 'Records retrieved');
}
```

#### lambda/ai-judgment-handler/index.js
```javascript
const { successResponse, errorResponse } = require('../../shared/response-utils');

exports.handler = async (event) => {
  try {
    console.log('AI Judgment Event:', JSON.stringify(event, null, 2));
    
    const { responses } = JSON.parse(event.body);
    
    // 규칙 기반 간단 판정 로직
    const judgment = judgeHealthStatus(responses);
    
    return successResponse(judgment, 'AI judgment completed');
    
  } catch (error) {
    console.error('AI Judgment Error:', error);
    return errorResponse(500, 'Internal Server Error');
  }
};

function judgeHealthStatus(responses) {
  // 1. 발열/설사/구토 증상 있음 → 자동 거부
  if (responses.symptoms === '있음') {
    return {
      result: 'rejected',
      reason: '발열/설사/구토 증상으로 출입 불가',
      confidence: 1.0,
      qr_eligible: false
    };
  }
  
  // 2. 호흡기 증상 있음 → 재확인 필요
  if (responses.respiratory === '있음') {
    return {
      result: 'recheck',
      reason: '호흡기 증상으로 재확인 필요',
      confidence: 0.8,
      qr_eligible: false
    };
  }
  
  // 3. 복장/상처 부적절 → 재확인 필요
  if (responses.clothing === '부적절' || responses.wound === '있음') {
    return {
      result: 'recheck',
      reason: '복장 또는 상처로 재확인 필요',
      confidence: 0.7,
      qr_eligible: false
    };
  }
  
  // 4. 모든 항목 정상 → 출입 가능
  return {
    result: 'approved',
    reason: '모든 항목이 정상 범위입니다',
    confidence: 0.95,
    qr_eligible: true
  };
}
```

### 5. 테스트 이벤트 작성

#### events/login.json
```json
{
  "httpMethod": "POST",
  "path": "/auth/login",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"user_id\":\"worker1\",\"password\":\"demo123\"}"
}
```

#### events/submit-checklist.json
```json
{
  "httpMethod": "POST",
  "path": "/checklists/submit",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"user_id\":\"worker1\",\"template_id\":\"hygiene_checklist\",\"responses\":{\"symptoms\":\"없음\",\"respiratory\":\"없음\",\"wound\":\"없음\",\"clothing\":\"적절\"}}"
}
```

### 6. 로컬 개발 스크립트

#### scripts/dev-start.sh
```bash
#!/bin/bash
echo "🚀 백엔드 로컬 개발 환경 시작..."

cd "$(dirname "$0")/.."

# 의존성 설치
echo "📦 의존성 설치 중..."
for dir in lambda/*/; do
  if [ -f "$dir/package.json" ]; then
    echo "Installing dependencies for $dir"
    (cd "$dir" && npm install)
  fi
done

# SAM Local API 시작
echo "🌐 SAM Local API 시작 (포트 3001)..."
sam local start-api --port 3001

echo "✅ 로컬 환경 준비 완료!"
echo "🌐 API: http://localhost:3001"
```

## 수용 기준
- [ ] SAM 템플릿 작성 완료
- [ ] Lambda 함수 5개 기본 구조 생성
- [ ] 공통 유틸리티 라이브러리 작성
- [ ] Mock 데이터 기반 핵심 API 구현
- [ ] 로컬 테스트 환경 구축 (SAM Local)
- [ ] 테스트 이벤트 작성 및 검증
- [ ] API 응답 형식 표준화
- [ ] CORS 설정 완료

## 참고 자료
- `development/setup/Lambda로컬개발가이드.md`
- `planning/design/architecture/API명세서.md`
- `planning/design/architecture/시스템아키텍처.md`
- `planning/design/architecture/데이터베이스스키마.md`

## 의존성
- **선행 작업**: TASK-20250905-1752 (시스템 아키텍처 설계) 완료
- **병렬 작업**: TASK-20250905-1858-01~04 (인프라 구축)
- **후속 작업**: 프론트엔드 개발 및 통합

## 위험 요소
- SAM Local 설정 복잡성
- Lambda 함수 간 의존성 관리
- Mock 데이터와 실제 데이터 간 차이

## 해커톤 최적화
- DynamoDB 대신 메모리 기반 Mock 데이터 사용
- 복잡한 인증 대신 간단한 토큰 방식
- 에러 처리 간소화
- 로그 출력 최대화 (디버깅 편의)

---
**생성일**: 2025-09-05 19:13  
**담당자**: 백승재  
**상태**: TODO  
**예상 완료**: 2025-09-06 09:00
