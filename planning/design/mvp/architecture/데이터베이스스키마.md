# 데이터베이스 스키마 (MVP)

## 개요
위생상태점검표 시스템 MVP를 위한 최소한의 데이터베이스 스키마 정의

## 데이터베이스 선택
- **Primary**: DynamoDB (NoSQL, 서버리스)
- **Cache**: 없음 (MVP 단순화)
- **File Storage**: S3 (AI 분석용 이미지)

## 테이블 구조

### 1. Users (사용자 정보)
```json
{
  "TableName": "gmp-users",
  "PartitionKey": "user_id",
  "Attributes": {
    "user_id": "String",        // EMP001, admin
    "user_type": "String",      // worker, admin
    "name": "String",           // 김철수
    "created_at": "String",     // ISO 8601
    "is_active": "Boolean"      // true/false
  }
}
```

**샘플 데이터:**
```json
{
  "user_id": "EMP001",
  "user_type": "worker", 
  "name": "김철수",
  "created_at": "2025-09-06T00:00:00Z",
  "is_active": true
}
```

### 2. Checklists (체크리스트 결과)
```json
{
  "TableName": "gmp-checklists",
  "PartitionKey": "user_id",
  "SortKey": "check_time",
  "Attributes": {
    "user_id": "String",           // EMP001
    "check_time": "String",        // 2025-09-06T08:15:00Z
    "status": "String",            // approved, rejected
    "items": "Map",                // 체크리스트 응답
    "ai_analysis": "Map",          // AI 분석 결과 (선택)
    "qr_code": "String",           // QR 코드 데이터 (선택)
    "expire_time": "String",       // QR 만료 시간 (선택)
    "rejection_reason": "String"   // 부적합 사유 (선택)
  }
}
```

**샘플 데이터 (적합):**
```json
{
  "user_id": "EMP001",
  "check_time": "2025-09-06T08:15:00Z",
  "status": "approved",
  "items": {
    "symptoms": "예",
    "respiratory": "예", 
    "wounds": "예",
    "uniform": "예",
    "accessories": "예",
    "hair": "예",
    "nails": "예",
    "makeup": "예",
    "personal_items": "예"
  },
  "ai_analysis": {
    "item_id": "wounds",
    "result": "approved",
    "confidence": 0.95,
    "image_url": "s3://bucket/images/emp001_20250906_0815.jpg"
  },
  "qr_code": "eyJ1c2VyX2lkIjoiRU1QMDAxIi...",
  "expire_time": "2025-09-06T08:45:00Z"
}
```

**샘플 데이터 (부적합):**
```json
{
  "user_id": "EMP002", 
  "check_time": "2025-09-06T08:20:00Z",
  "status": "rejected",
  "items": {
    "symptoms": "아니오",
    "respiratory": "예",
    "wounds": "예",
    "uniform": "예",
    "accessories": "예", 
    "hair": "예",
    "nails": "예",
    "makeup": "예",
    "personal_items": "예"
  },
  "rejection_reason": "발열, 설사, 구토 등의 증상"
}
```

### 3. AccessLogs (출입 로그)
```json
{
  "TableName": "gmp-access-logs",
  "PartitionKey": "date",
  "SortKey": "timestamp",
  "Attributes": {
    "date": "String",              // 2025-09-06
    "timestamp": "String",         // 2025-09-06T08:15:30Z
    "user_id": "String",           // EMP001
    "user_name": "String",         // 김철수
    "action": "String",            // scan_success, scan_failed
    "result": "String",            // approved, expired, invalid
    "qr_data": "String",           // QR 코드 원본 데이터
    "scanner_id": "String"         // admin, manager
  }
}
```

**샘플 데이터:**
```json
{
  "date": "2025-09-06",
  "timestamp": "2025-09-06T08:15:30Z", 
  "user_id": "EMP001",
  "user_name": "김철수",
  "action": "scan_success",
  "result": "approved",
  "qr_data": "eyJ1c2VyX2lkIjoiRU1QMDAxIi...",
  "scanner_id": "admin"
}
```

## 인덱스 설계

### Users 테이블
- **Primary**: user_id (Partition Key)
- **GSI**: user_type-name-index (사용자 타입별 조회)

### Checklists 테이블  
- **Primary**: user_id (PK) + check_time (SK)
- **GSI**: status-check_time-index (상태별 조회)
- **LSI**: user_id-status-index (사용자별 상태 조회)

### AccessLogs 테이블
- **Primary**: date (PK) + timestamp (SK)
- **GSI**: user_id-timestamp-index (사용자별 로그 조회)

## 데이터 접근 패턴

### 1. 사용자 인증
```
Query: Users.user_id = "EMP001"
Response: 사용자 정보
```

### 2. 체크리스트 저장
```
PutItem: Checklists
Data: 체크리스트 결과 + QR 정보
```

### 3. 사용자별 최근 결과 조회
```
Query: Checklists.user_id = "EMP001"
SortKeyCondition: check_time DESC
Limit: 10
```

### 4. QR 코드 검증
```
Query: Checklists.user_id = "EMP001" 
FilterExpression: qr_code = "..." AND expire_time > now()
```

### 5. 출입 로그 기록
```
PutItem: AccessLogs
Data: 스캔 결과 정보
```

### 6. 일일 출입 로그 조회
```
Query: AccessLogs.date = "2025-09-06"
SortKeyCondition: timestamp DESC
```

## 용량 계산 (MVP)

### 예상 데이터량
- **사용자**: 100명 (고정)
- **일일 체크리스트**: 100건/일
- **일일 출입 로그**: 200건/일 (재시도 포함)

### 월간 데이터량
- **Checklists**: 3,000건/월 × 2KB = 6MB/월
- **AccessLogs**: 6,000건/월 × 1KB = 6MB/월
- **총 용량**: 12MB/월 (매우 작음)

### DynamoDB 비용 (예상)
- **Read**: 1,000 RCU/월 = $0.25/월
- **Write**: 500 WCU/월 = $1.25/월
- **Storage**: 12MB = $0.003/월
- **총 비용**: ~$1.5/월

## 백업 및 보안

### 백업 정책
- **Point-in-time Recovery**: 활성화
- **On-demand Backup**: 주간 1회
- **Cross-region Backup**: 비활성화 (MVP)

### 보안 설정
- **Encryption**: 저장 시 암호화 (AWS KMS)
- **Access Control**: IAM 역할 기반
- **VPC**: 퍼블릭 액세스 (API Gateway 통해서만)

### 데이터 보존
- **Checklists**: 1년 보존
- **AccessLogs**: 3개월 보존  
- **Users**: 영구 보존

## 확장 고려사항

### 성능 최적화
- **Hot Partition 방지**: 날짜별 분산
- **Batch Operations**: 대량 조회 시 활용
- **Connection Pooling**: Lambda에서 재사용

### 향후 확장
- **ElastiCache**: 자주 조회되는 데이터 캐싱
- **RDS**: 복잡한 분석 쿼리 필요 시
- **OpenSearch**: 로그 검색 기능 필요 시

---
**작성일**: 2025-09-06  
**상태**: MVP 개발 준비 완료
