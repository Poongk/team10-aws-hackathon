# 시스템 아키텍처 (MVP)

## 개요
위생상태점검표 시스템 MVP를 위한 서버리스 아키텍처 설계

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client Layer                             │
├─────────────────────────────────────────────────────────────────┤
│  📱 Worker Mobile App    │    🖥️ Admin Web App                  │
│  (React PWA)             │    (React SPA)                       │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         CDN Layer                               │
├─────────────────────────────────────────────────────────────────┤
│                    🌐 CloudFront                               │
│                  (Static Assets + API Cache)                   │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API Layer                               │
├─────────────────────────────────────────────────────────────────┤
│                   🚪 API Gateway                               │
│              (REST API + Authentication)                       │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Compute Layer                              │
├─────────────────────────────────────────────────────────────────┤
│  ⚡ Lambda Functions                                           │
│  ├── auth-service          ├── ai-service                     │
│  ├── checklist-service     ├── qr-service                     │
│  └── access-log-service    └── notification-service           │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Storage Layer                             │
├─────────────────────────────────────────────────────────────────┤
│  🗄️ DynamoDB              📁 S3                               │
│  ├── Users                ├── Images                          │
│  ├── Checklists           ├── QR Codes                        │
│  └── AccessLogs           └── Backups                         │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AI Layer                               │
├─────────────────────────────────────────────────────────────────┤
│                    🤖 Amazon Bedrock                          │
│                   (Claude-3 Vision Model)                     │
└─────────────────────────────────────────────────────────────────┘
```

## 컴포넌트 상세

### 1. Client Layer

#### 작업자 모바일 앱
- **기술**: React PWA (Progressive Web App)
- **배포**: S3 + CloudFront
- **기능**: 체크리스트 작성, QR 표시, 결과 조회
- **오프라인**: 기본 캐싱 지원

#### 관리자 웹 앱  
- **기술**: React SPA (Single Page Application)
- **배포**: S3 + CloudFront
- **기능**: QR 스캔, 출입 로그 관리
- **실시간**: WebSocket 연결 (선택사항)

### 2. API Layer

#### API Gateway
- **타입**: REST API
- **인증**: API Key + JWT Token
- **CORS**: 활성화 (모바일 앱 지원)
- **Rate Limiting**: 사용자별 제한
- **로깅**: CloudWatch 연동

**엔드포인트 구조:**
```
/v1/auth/*          → auth-service
/v1/checklist/*     → checklist-service  
/v1/ai/*            → ai-service
/v1/qr/*            → qr-service
/v1/access-log/*    → access-log-service
```

### 3. Compute Layer

#### Lambda Functions

**auth-service**
- **Runtime**: Node.js 18
- **Memory**: 256MB
- **Timeout**: 10초
- **기능**: 사용자 인증, 세션 관리

**checklist-service**
- **Runtime**: Node.js 18  
- **Memory**: 512MB
- **Timeout**: 30초
- **기능**: 체크리스트 처리, 판정 로직

**ai-service**
- **Runtime**: Python 3.11
- **Memory**: 1024MB
- **Timeout**: 60초
- **기능**: 이미지 분석, Bedrock 연동

**qr-service**
- **Runtime**: Node.js 18
- **Memory**: 256MB  
- **Timeout**: 10초
- **기능**: QR 생성/검증, 만료 처리

**access-log-service**
- **Runtime**: Node.js 18
- **Memory**: 256MB
- **Timeout**: 10초  
- **기능**: 출입 로그 기록/조회

### 4. Storage Layer

#### DynamoDB 테이블
- **Users**: 사용자 정보 (100개 레코드)
- **Checklists**: 체크리스트 결과 (3,000개/월)
- **AccessLogs**: 출입 로그 (6,000개/월)
- **설정**: On-Demand 빌링, 암호화 활성화

#### S3 버킷
- **gmp-images**: AI 분석용 이미지 저장
- **gmp-qr-codes**: QR 코드 이미지 (선택사항)
- **gmp-backups**: 데이터 백업
- **설정**: 버전 관리, 수명 주기 정책

### 5. AI Layer

#### Amazon Bedrock
- **모델**: Claude-3 Haiku (비용 효율적)
- **기능**: 상처 이미지 분석
- **입력**: JPEG/PNG 이미지 (최대 5MB)
- **출력**: JSON 형태 분석 결과

## 데이터 플로우

### 1. 체크리스트 제출 플로우
```
Mobile App → API Gateway → checklist-service → DynamoDB
     ↓
AI 분석 필요 시
     ↓
S3 (이미지 저장) → ai-service → Bedrock → 분석 결과 반환
     ↓
QR 코드 생성 → qr-service → 최종 응답
```

### 2. QR 스캔 플로우
```
Admin App → API Gateway → qr-service → DynamoDB (검증)
     ↓
access-log-service → DynamoDB (로그 기록)
     ↓
실시간 결과 반환
```

### 3. AI 분석 플로우
```
이미지 업로드 → S3 → ai-service → Bedrock
     ↓
분석 결과 → DynamoDB 저장 → 클라이언트 응답
```

## 보안 아키텍처

### 네트워크 보안
- **HTTPS Only**: 모든 통신 암호화
- **API Gateway**: WAF 연동 (DDoS 방지)
- **CloudFront**: 지리적 제한 (필요시)

### 인증/인가
- **API Key**: 기본 API 접근 제어
- **JWT Token**: 사용자 세션 관리
- **IAM Roles**: Lambda 함수별 최소 권한

### 데이터 보안
- **DynamoDB**: 저장 시 암호화 (KMS)
- **S3**: 서버 측 암호화 (AES-256)
- **Lambda**: 환경 변수 암호화

## 모니터링 및 로깅

### CloudWatch 메트릭
- **API Gateway**: 요청 수, 응답 시간, 오류율
- **Lambda**: 실행 시간, 메모리 사용량, 오류
- **DynamoDB**: 읽기/쓰기 용량, 스로틀링

### 로그 수집
- **API Gateway**: 액세스 로그
- **Lambda**: 함수 실행 로그  
- **Application**: 비즈니스 로직 로그

### 알람 설정
- **오류율 > 5%**: 즉시 알람
- **응답 시간 > 3초**: 경고 알람
- **DynamoDB 스로틀링**: 용량 증설 알람

## 성능 최적화

### 캐싱 전략
- **CloudFront**: 정적 자산 (24시간)
- **API Gateway**: GET 요청 (5분)
- **Lambda**: 연결 풀링, 코드 최적화

### 데이터베이스 최적화
- **DynamoDB**: 적절한 파티션 키 설계
- **인덱스**: 자주 조회되는 패턴에 GSI 생성
- **배치 처리**: 대량 데이터 처리 시 활용

### 이미지 처리 최적화
- **압축**: 클라이언트에서 이미지 압축
- **리사이징**: Lambda에서 적절한 크기로 조정
- **형식 변환**: WebP 형식 지원

## 비용 최적화

### 예상 월간 비용 (MVP)
```
API Gateway:     $3.50  (1M requests)
Lambda:          $5.00  (compute time)
DynamoDB:        $1.50  (on-demand)
S3:              $2.00  (storage + transfer)
Bedrock:         $10.00 (AI analysis)
CloudFront:      $1.00  (CDN)
────────────────────────
Total:          ~$23.00/month
```

### 비용 절감 방안
- **Reserved Capacity**: DynamoDB (예측 가능한 워크로드)
- **S3 Intelligent Tiering**: 자동 스토리지 클래스 전환
- **Lambda Provisioned**: 높은 동시성 필요 시

## 배포 전략

### 환경 구성
- **dev**: 개발 환경 (최소 리소스)
- **staging**: 스테이징 환경 (프로덕션 유사)
- **prod**: 프로덕션 환경 (고가용성)

### CI/CD 파이프라인
```
GitHub → GitHub Actions → AWS CodeBuild → CloudFormation → 배포
```

### 배포 단계
1. **Infrastructure**: CloudFormation/CDK
2. **Backend**: Lambda 함수 배포
3. **Frontend**: S3 + CloudFront 배포
4. **Database**: DynamoDB 테이블 생성
5. **Configuration**: 환경 변수 설정

## 재해 복구

### 백업 전략
- **DynamoDB**: Point-in-time Recovery (35일)
- **S3**: Cross-Region Replication (선택사항)
- **Lambda**: 코드 버전 관리

### 복구 시나리오
- **RTO**: 4시간 (Recovery Time Objective)
- **RPO**: 1시간 (Recovery Point Objective)
- **Multi-AZ**: 자동 장애 조치

---
**작성일**: 2025-09-06  
**상태**: MVP 개발 준비 완료
