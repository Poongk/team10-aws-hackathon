# GMP CheckMaster AI - 데이터베이스 스키마

## 개요
- **데이터베이스**: Amazon DynamoDB
- **설계 기준**: 요구사항 정의서 v2.0, 사용자 스토리 29개, API 명세서
- **테이블 수**: 5개 (Users, Templates, CheckRecords, Assignments, AccessLogs)
- **작성일**: 2025-09-05

## 설계 원칙

### DynamoDB 설계 원칙
- **Single Table Design 지양**: 해커톤 단순화를 위해 기능별 테이블 분리
- **파티션 키 최적화**: 균등한 데이터 분산
- **GSI 활용**: 다양한 쿼리 패턴 지원
- **확장성 고려**: Auto Scaling 적용 가능한 구조

### 데이터 타입 규칙
- **String**: 텍스트, ID, 상태값
- **Number**: 숫자, 타임스탬프
- **Boolean**: true/false 값
- **List**: 배열 데이터
- **Map**: 중첩 객체

## 1. Users 테이블

### 기본 정보
- **용도**: 사용자 정보 및 인증 관리
- **파티션 키**: user_id (String)
- **정렬 키**: 없음

### 스키마
```json
{
  "user_id": "worker1",                    // PK: 사용자 ID
  "name": "김작업",                        // 사용자 이름
  "role": "worker",                       // 역할 (worker/operator/supervisor/admin/security)
  "team": "생산팀A",                       // 소속 팀
  "department": "생산부",                  // 소속 부서
  "position": "사원",                      // 직급
  "email": "worker1@ildong.com",          // 이메일 (선택)
  "phone": "010-1234-5678",               // 전화번호 (선택)
  "active": true,                         // 활성 상태
  "last_login": 1693900800,               // 마지막 로그인 (Unix timestamp)
  "created_at": 1693900800,               // 생성일시
  "updated_at": 1693900800                // 수정일시
}
```

### GSI (Global Secondary Index)
```json
// GSI-1: 팀별 사용자 조회
{
  "IndexName": "TeamIndex",
  "PartitionKey": "team",
  "SortKey": "role",
  "ProjectionType": "ALL"
}

// GSI-2: 역할별 사용자 조회  
{
  "IndexName": "RoleIndex",
  "PartitionKey": "role",
  "SortKey": "user_id",
  "ProjectionType": "ALL"
}
```

### 쿼리 패턴
- 사용자 정보 조회: `user_id`
- 팀별 사용자 목록: `TeamIndex`
- 역할별 사용자 목록: `RoleIndex`

## 2. Templates 테이블

### 기본 정보
- **용도**: 체크리스트 템플릿 관리
- **파티션 키**: template_id (String)
- **정렬 키**: 없음

### 스키마
```json
{
  "template_id": "template_001",           // PK: 템플릿 ID
  "name": "위생상태점검표",                 // 템플릿 이름
  "type": "hygiene",                      // 타입 (hygiene/pressure/storage)
  "description": "출입 전 위생상태 확인용",  // 설명
  "version": "1.0",                       // 버전
  "items": [                              // 체크 항목들
    {
      "item_id": "item_001",
      "question": "손 씻기를 완료하셨나요?",
      "type": "boolean",                  // boolean/number/text/select
      "required": true,
      "options": null,                    // select 타입일 때 선택지
      "validation": {                     // 검증 규칙
        "min": null,
        "max": null,
        "unit": null
      }
    },
    {
      "item_id": "item_002",
      "question": "체온을 측정하셨나요?",
      "type": "number",
      "required": true,
      "validation": {
        "min": 35.0,
        "max": 38.0,
        "unit": "°C"
      }
    }
  ],
  "ai_judgment_rules": {                  // AI 판정 규칙
    "type": "complex",                    // complex/numeric/risk
    "weight_config": {
      "item_001": 0.3,
      "item_002": 0.7
    },
    "thresholds": {
      "approved": 0.8,
      "warning": 0.6,
      "rejected": 0.4
    }
  },
  "active": true,                         // 활성 상태
  "created_by": "admin1",                 // 생성자
  "created_at": 1693900800,               // 생성일시
  "updated_at": 1693900800                // 수정일시
}
```

### GSI
```json
// GSI-1: 타입별 템플릿 조회
{
  "IndexName": "TypeIndex",
  "PartitionKey": "type",
  "SortKey": "created_at",
  "ProjectionType": "ALL"
}
```

### 쿼리 패턴
- 템플릿 상세 조회: `template_id`
- 타입별 템플릿 목록: `TypeIndex`
- 활성 템플릿 목록: Scan with FilterExpression

## 3. CheckRecords 테이블

### 기본 정보
- **용도**: 체크리스트 작성 기록 및 AI 판정 결과
- **파티션 키**: record_id (String)
- **정렬 키**: 없음

### 스키마
```json
{
  "record_id": "record_20250905_001",     // PK: 기록 ID (날짜_순번)
  "template_id": "template_001",          // 사용된 템플릿 ID
  "template_name": "위생상태점검표",       // 템플릿 이름 (비정규화)
  "template_type": "hygiene",             // 템플릿 타입 (비정규화)
  "user_id": "worker1",                   // 작성자 ID
  "user_name": "김작업",                  // 작성자 이름 (비정규화)
  "user_team": "생산팀A",                 // 작성자 팀 (비정규화)
  "responses": [                          // 응답 데이터
    {
      "item_id": "item_001",
      "question": "손 씻기를 완료하셨나요?",
      "value": true,
      "type": "boolean"
    },
    {
      "item_id": "item_002", 
      "question": "체온을 측정하셨나요?",
      "value": 36.5,
      "type": "number",
      "unit": "°C"
    }
  ],
  "ai_judgment": {                        // AI 판정 결과
    "result": "approved",                 // approved/warning/rejected/medical_consultation
    "confidence": 0.95,                   // 신뢰도 (0-1)
    "reason": "모든 항목이 정상 범위입니다.", // 판정 이유
    "recommendations": [],                // 권장사항
    "risk_level": "low",                  // 위험도 (low/medium/high)
    "processed_at": 1693900805            // AI 처리 시간
  },
  "qr_code": {                           // QR 코드 정보
    "code": "QR_20250905_001",           // QR 코드 ID
    "data": "eyJyZWNvcmRfaWQi...",       // 암호화된 QR 데이터
    "color": "green",                    // 색상 (green/yellow/red)
    "expires_at": 1693902600,            // 만료 시간 (30분 후)
    "generated_at": 1693900800           // 생성 시간
  },
  "modification_history": [              // 수정 이력 (새로 추가)
    {
      "modified_at": 1693900900,         // 수정 시간
      "modified_by": "worker1",          // 수정자 ID
      "modification_type": "self_edit",  // 수정 유형 (self_edit/operator_approved/emergency_review)
      "reason": "복장을 정리했습니다",    // 수정 사유
      "changes": [                       // 변경 내용
        {
          "item_id": "item_004",
          "old_value": "부적절",
          "new_value": "적절"
        }
      ]
    }
  ],
  "modification_requests": [             // 수정 요청 이력 (새로 추가)
    {
      "request_id": "mod_req_001",
      "requested_at": 1693901200,
      "requested_by": "worker1",
      "reason": "복장을 정리했습니다",
      "status": "approved",              // pending/approved/rejected
      "approved_by": "operator1",
      "approved_at": 1693901300
    }
  ],
  "can_modify_until": 1693901100,       // 수정 가능 시간 (제출 후 5분) (새로 추가)
  "modification_count": 0,              // 수정 횟수 (1일 최대 3회 제한) (새로 추가)
  "non_compliance_action": {             // 부적합자 조치 (위생상태점검표 전용)
    "required": false,                   // 조치 필요 여부 (AI 판정 결과에 따라)
    "action_reason": null,               // 조치 이유 (예: "체온 38.2도로 발열 의심")
    "action_taken": null,                // 조치 내용 (예: "귀가 조치", "의료진 상담 후 재검토")
    "action_by": null,                   // 조치자 ID (운영자 또는 책임자)
    "action_by_name": null,              // 조치자 이름
    "confirmed_by": null,                // 확인자 ID (책임자 또는 관리자)
    "confirmed_by_name": null,           // 확인자 이름
    "action_time": null,                 // 조치 시간
    "confirmed_time": null,              // 확인 시간
    "notes": null                        // 추가 메모
  },
  "status": "completed",                  // 상태 (submitted/judged/completed)
  "submitted_at": 1693900800,             // 제출 시간
  "completed_at": 1693900805,             // 완료 시간
  "date": "2025-09-05",                  // 날짜 (YYYY-MM-DD)
  "created_at": 1693900800               // 생성일시
}
```

### GSI
```json
// GSI-1: 사용자별 기록 조회
{
  "IndexName": "UserIndex",
  "PartitionKey": "user_id",
  "SortKey": "submitted_at",
  "ProjectionType": "ALL"
}

// GSI-2: 날짜별 기록 조회
{
  "IndexName": "DateIndex", 
  "PartitionKey": "date",
  "SortKey": "submitted_at",
  "ProjectionType": "ALL"
}

// GSI-3: 팀별 기록 조회
{
  "IndexName": "TeamDateIndex",
  "PartitionKey": "user_team",
  "SortKey": "date",
  "ProjectionType": "ALL"
}

// GSI-4: 상태별 기록 조회
{
  "IndexName": "StatusIndex",
  "PartitionKey": "status",
  "SortKey": "submitted_at", 
  "ProjectionType": "ALL"
}

// GSI-5: 부적합자 조치 관리 (위생상태점검표 전용)
{
  "IndexName": "NonComplianceIndex",
  "PartitionKey": "template_type",
  "SortKey": "submitted_at",
  "ProjectionType": "ALL",
  "FilterExpression": "non_compliance_action.required = true"
}
```

### 쿼리 패턴
- 기록 상세 조회: `record_id`
- 사용자별 기록 목록: `UserIndex`
- 날짜별 전체 기록: `DateIndex`
- 팀별 날짜 기록: `TeamDateIndex`
- 미완료 기록 조회: `StatusIndex`
- 부적합자 조치 관리: `NonComplianceIndex` (위생상태점검표 전용)

## 4. Assignments 테이블

### 기본 정보
- **용도**: 작업자별 체크리스트 배정 및 스케줄 관리
- **파티션 키**: assignment_id (String)
- **정렬 키**: 없음

### 스키마
```json
{
  "assignment_id": "assign_001",          // PK: 배정 ID
  "template_id": "template_001",          // 템플릿 ID
  "template_name": "위생상태점검표",       // 템플릿 이름 (비정규화)
  "template_type": "hygiene",             // 템플릿 타입 (비정규화)
  "user_id": "worker1",                   // 배정된 사용자 ID
  "user_name": "김작업",                  // 사용자 이름 (비정규화)
  "user_team": "생산팀A",                 // 사용자 팀 (비정규화)
  "schedule": {                           // 스케줄 설정
    "type": "recurring",                  // recurring/one_time
    "days": ["monday", "tuesday", "wednesday", "thursday", "friday"], // 요일
    "deadline": "08:20",                  // 마감 시간 (HH:MM)
    "timezone": "Asia/Seoul"              // 시간대
  },
  "exceptions": [                         // 예외 설정
    {
      "date": "2025-09-06",              // 예외 날짜
      "type": "skip",                     // skip/custom
      "reason": "휴가",                   // 사유
      "custom_deadline": null             // 커스텀 마감시간
    }
  ],
  "notifications": {                      // 알림 설정
    "reminder_minutes": [30, 10],         // 마감 전 알림 (분)
    "overdue_enabled": true,              // 연체 알림 여부
    "escalation_enabled": false           // 에스컬레이션 여부
  },
  "active": true,                         // 활성 상태
  "created_by": "operator1",              // 생성자
  "created_at": 1693900800,               // 생성일시
  "updated_at": 1693900800                // 수정일시
}
```

### GSI
```json
// GSI-1: 사용자별 배정 조회
{
  "IndexName": "UserAssignmentIndex",
  "PartitionKey": "user_id",
  "SortKey": "created_at",
  "ProjectionType": "ALL"
}

// GSI-2: 템플릿별 배정 조회
{
  "IndexName": "TemplateAssignmentIndex",
  "PartitionKey": "template_id", 
  "SortKey": "user_id",
  "ProjectionType": "ALL"
}

// GSI-3: 팀별 배정 조회
{
  "IndexName": "TeamAssignmentIndex",
  "PartitionKey": "user_team",
  "SortKey": "template_type",
  "ProjectionType": "ALL"
}
```

### 쿼리 패턴
- 배정 상세 조회: `assignment_id`
- 사용자별 배정 목록: `UserAssignmentIndex`
- 템플릿별 배정 목록: `TemplateAssignmentIndex`
- 팀별 배정 현황: `TeamAssignmentIndex`

## 5. AccessLogs 테이블

### 기본 정보
- **용도**: QR 코드 기반 출입 로그 기록
- **파티션 키**: log_id (String)
- **정렬 키**: 없음

### 스키마
```json
{
  "log_id": "log_20250905_001",           // PK: 로그 ID (날짜_순번)
  "record_id": "record_20250905_001",     // 체크 기록 ID
  "qr_code": "QR_20250905_001",          // QR 코드 ID
  "user_id": "worker1",                   // 사용자 ID
  "user_name": "김작업",                  // 사용자 이름 (비정규화)
  "user_team": "생산팀A",                 // 사용자 팀 (비정규화)
  "security_officer": "security1",        // 보안담당자 ID
  "security_name": "정보안",              // 보안담당자 이름 (비정규화)
  "access_result": "allowed",             // 출입 결과 (allowed/denied)
  "access_reason": "정상 판정",           // 출입 사유
  "judgment_result": "approved",          // AI 판정 결과 (비정규화)
  "location": "정문",                     // 출입 위치
  "device_info": {                        // 스캔 디바이스 정보
    "device_id": "tablet_001",
    "device_type": "mobile",
    "app_version": "1.0.0"
  },
  "qr_scan_time": 1693900900,            // QR 스캔 시간
  "access_granted_time": 1693900901,      // 출입 허용 시간
  "date": "2025-09-05",                  // 날짜 (YYYY-MM-DD)
  "created_at": 1693900900               // 생성일시
}
```

### GSI
```json
// GSI-1: 사용자별 출입 로그
{
  "IndexName": "UserAccessIndex",
  "PartitionKey": "user_id",
  "SortKey": "qr_scan_time",
  "ProjectionType": "ALL"
}

// GSI-2: 날짜별 출입 로그
{
  "IndexName": "DateAccessIndex",
  "PartitionKey": "date",
  "SortKey": "qr_scan_time", 
  "ProjectionType": "ALL"
}

// GSI-3: 팀별 출입 로그
{
  "IndexName": "TeamAccessIndex",
  "PartitionKey": "user_team",
  "SortKey": "date",
  "ProjectionType": "ALL"
}

// GSI-4: 보안담당자별 로그
{
  "IndexName": "SecurityOfficerIndex",
  "PartitionKey": "security_officer",
  "SortKey": "qr_scan_time",
  "ProjectionType": "ALL"
}
```

### 쿼리 패턴
- 로그 상세 조회: `log_id`
- 사용자별 출입 이력: `UserAccessIndex`
- 날짜별 출입 현황: `DateAccessIndex`
- 팀별 출입 통계: `TeamAccessIndex`
- 보안담당자별 처리 이력: `SecurityOfficerIndex`

## 데이터 관계도

```
Users (1) ←→ (N) CheckRecords
Users (1) ←→ (N) Assignments  
Users (1) ←→ (N) AccessLogs

Templates (1) ←→ (N) CheckRecords
Templates (1) ←→ (N) Assignments

CheckRecords (1) ←→ (1) AccessLogs
```

## 용량 및 성능 예상

### 예상 데이터 볼륨 (100명 사용자 기준)
- **Users**: 100개 항목 (< 1MB)
- **Templates**: 10개 항목 (< 1MB)  
- **CheckRecords**: 월 2,000개 (약 10MB/월)
- **Assignments**: 200개 항목 (< 1MB)
- **AccessLogs**: 월 2,000개 (약 5MB/월)

### 성능 설정
- **읽기 용량**: 5 RCU (Auto Scaling)
- **쓰기 용량**: 5 WCU (Auto Scaling)
- **GSI 용량**: 각 5 RCU/WCU (Auto Scaling)

## 백업 및 보안

### 백업 설정
- **Point-in-Time Recovery**: 활성화 (35일 보관)
- **On-Demand Backup**: 주요 업데이트 전 수동 백업
- **Cross-Region Backup**: 필요시 서울 → 도쿄 복제

### 보안 설정
- **암호화**: 기본 암호화 활성화 (AWS 관리형 키)
- **접근 제어**: IAM 역할 기반 세밀한 권한 관리
- **VPC 엔드포인트**: 프라이빗 네트워크 접근

---
**설계자**: 백승재  
**검토자**: 풍기덕  
**버전**: v1.0  
**다음 단계**: 개발 환경 가이드 작성
