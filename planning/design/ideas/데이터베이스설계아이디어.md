# 데이터베이스 설계 아이디어

## 개요
GMP CheckMaster AI 시스템의 MVP 데이터베이스 설계 아이디어 및 확장 방안

**설계 원칙**: 간단하면서도 확장 가능한 구조  
**기술 선택**: DynamoDB (서버리스, AWS 통합)  
**목표**: 해커톤 24시간 내 구현 가능한 최소 구조

## MVP 데이터베이스 설계 (DynamoDB)

### 핵심 테이블 4개 (최소 구성)

#### 1. Users (사용자 관리)
```json
{
  "PK": "USER#user_001",
  "SK": "PROFILE",
  "user_id": "user_001",
  "name": "김작업자",
  "department": "생산부",
  "team": "A팀",
  "role": "worker",
  "status": "active",
  "email": "kim@company.com",
  "phone": "010-1234-5678",
  "created_at": "2025-09-05T10:00:00Z",
  "updated_at": "2025-09-05T10:00:00Z"
}
```

**용도**: 사용자 기본 정보 및 권한 관리  
**인덱스**: PK로 빠른 사용자 조회

#### 2. Templates (체크리스트 템플릿)
```json
{
  "PK": "TEMPLATE#hygiene_daily",
  "SK": "CONFIG",
  "template_id": "hygiene_daily",
  "name": "작업원 일일 위생상태 점검표",
  "type": "access_control",
  "version": "1.0",
  "status": "active",
  "items": [
    {
      "id": "symptoms",
      "question": "발열, 설사, 구토 등의 증상이 있습니까?",
      "type": "select",
      "options": ["있음", "없음"],
      "risk_weight": 10,
      "required": true
    },
    {
      "id": "temperature",
      "question": "체온을 입력하세요 (°C)",
      "type": "number",
      "validation": {"min": 35.0, "max": 42.0},
      "risk_weight": 9,
      "required": true
    }
    // ... 8개 항목 더
  ],
  "ai_rules": {
    "auto_reject": [
      "symptoms=있음",
      "temperature>37.5"
    ],
    "recheck": [
      "respiratory=있음",
      "wounds=있음",
      "uniform=부적절"
    ],
    "warning": [
      "makeup=부적절",
      "temperature>=37.0 AND temperature<=37.5"
    ],
    "medical": [
      "temperature>38.0",
      "symptoms=있음 AND respiratory=있음"
    ]
  },
  "created_at": "2025-09-05T10:00:00Z"
}
```

**용도**: 체크리스트 구조 및 AI 판정 규칙 정의  
**확장성**: 새로운 체크리스트 템플릿 쉽게 추가

#### 3. CheckRecords (체크 기록)
```json
{
  "PK": "RECORD#2025-09-05",
  "SK": "USER#user_001#08:15:30",
  "record_id": "rec_20250905_001",
  "user_id": "user_001",
  "user_name": "김작업자",
  "department": "생산부",
  "team": "A팀",
  "template_id": "hygiene_daily",
  "template_name": "작업원 일일 위생상태 점검표",
  "responses": {
    "symptoms": "없음",
    "temperature": 36.5,
    "respiratory": "없음",
    "wounds": "없음",
    "uniform": "적절",
    "accessories": true,
    "hair": "단정함",
    "nails": "적절",
    "makeup": "적절",
    "personal_items": true
  },
  "ai_judgment": {
    "result": "approved",
    "score": 95,
    "reason": "모든 항목 정상 범위",
    "message": "위생상태 점검 완료! 안전하게 작업하세요 💪",
    "risk_factors": [],
    "processing_time": 3.2
  },
  "created_at": "2025-09-05T08:15:30Z",
  "status": "completed",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0..."
}
```

**용도**: 실제 체크 기록 및 AI 판정 결과 저장  
**파티션**: 날짜별로 분산하여 성능 최적화

#### 4. Assignments (배정 관리)
```json
{
  "PK": "ASSIGNMENT#2025-09-05",
  "SK": "USER#user_001",
  "assignment_id": "assign_20250905_001",
  "user_id": "user_001",
  "user_name": "김작업자",
  "department": "생산부",
  "team": "A팀",
  "template_id": "hygiene_daily",
  "schedule": {
    "days": ["MON", "TUE", "WED", "THU", "FRI"],
    "deadline": "08:20",
    "timezone": "Asia/Seoul",
    "reminder": "07:30"
  },
  "status": "active",
  "exceptions": {
    "vacation": false,
    "sick_leave": false,
    "business_trip": false,
    "special_work": false,
    "exemption_reason": null
  },
  "assigned_by": "operator_001",
  "assigned_at": "2025-09-05T07:00:00Z",
  "effective_date": "2025-09-05",
  "expiry_date": null
}
```

**용도**: 사용자별 체크리스트 배정 및 예외 관리  
**유연성**: 개별/부서별/임시 배정 모두 지원

### DynamoDB 인덱스 설계

#### GSI-1: UserIndex
- **PK**: `user_id`
- **SK**: `created_at`
- **용도**: 사용자별 체크 이력 조회
- **쿼리 예시**: 특정 사용자의 최근 7일 체크 기록

#### GSI-2: DateIndex
- **PK**: `date` (YYYY-MM-DD)
- **SK**: `created_at`
- **용도**: 일별 전체 현황 조회
- **쿼리 예시**: 오늘 전체 완료율, 시간대별 완료 추이

#### GSI-3: StatusIndex
- **PK**: `status#template_id`
- **SK**: `created_at`
- **용도**: 미완료자 실시간 조회
- **쿼리 예시**: 현재 미완료자 목록, 출입 불가자 목록

#### GSI-4: TeamIndex
- **PK**: `team#date`
- **SK**: `created_at`
- **용도**: 팀별 현황 조회 (책임자용)
- **쿼리 예시**: A팀 오늘 완료 현황

## API 설계 (RESTful)

### 체크리스트 관련
```
POST   /api/v1/checklist/submit
       Body: { user_id, template_id, responses }
       Response: { record_id, ai_judgment }

GET    /api/v1/checklist/status/{user_id}
       Response: { today_status, pending_checklists }

GET    /api/v1/checklist/history/{user_id}?days=7
       Response: { records[], summary }

GET    /api/v1/checklist/template/{template_id}
       Response: { template_config, items[] }
```

### 대시보드 관련
```
GET    /api/v1/dashboard/overview/{date}
       Response: { total_users, completed, completion_rate, rejected }

GET    /api/v1/dashboard/incomplete/{date}
       Response: { incomplete_users[], overdue_users[] }

GET    /api/v1/dashboard/team/{team_id}/{date}
       Response: { team_stats, member_status[] }

GET    /api/v1/dashboard/realtime/{date}
       Response: { current_stats, hourly_trend[] }
```

### 관리 관련
```
POST   /api/v1/assignment/assign
       Body: { user_ids[], template_id, schedule }
       Response: { assignment_ids[] }

GET    /api/v1/assignment/list/{date}
       Response: { assignments[] }

PUT    /api/v1/assignment/{assignment_id}/exception
       Body: { exception_type, reason, duration }
       Response: { updated_assignment }

DELETE /api/v1/assignment/{assignment_id}
       Response: { success }
```

## 기술 스택 선택 근거

### DynamoDB 선택 이유
✅ **장점**:
- 서버리스 (관리 부담 없음)
- 자동 스케일링 (트래픽 증가 대응)
- AWS 서비스 통합 (Lambda, API Gateway)
- 빠른 읽기/쓰기 성능
- 해커톤에 적합한 빠른 설정

❌ **단점**:
- 복잡한 쿼리 제한 (JOIN 불가)
- 스키마 변경 어려움
- 비용 예측 어려움 (대용량 시)

### 대안 기술 비교

#### RDS (MySQL/PostgreSQL)
- **장점**: 복잡한 쿼리, 트랜잭션, 표준 SQL
- **단점**: 서버 관리, 스케일링 복잡, 해커톤 시간 부족
- **결론**: Phase 2에서 고려

#### DocumentDB (MongoDB 호환)
- **장점**: 유연한 스키마, 복잡한 쿼리
- **단점**: 높은 비용, 관리 복잡성
- **결론**: 상용화 단계에서 고려

## 성능 최적화 전략

### 읽기 최적화
```javascript
// 자주 조회하는 데이터 캐싱
const cacheStrategy = {
  user_profile: "1시간 캐시",
  template_config: "24시간 캐시", 
  daily_stats: "5분 캐시",
  realtime_status: "30초 캐시"
};

// ElastiCache Redis 활용
const redis = new Redis(process.env.REDIS_URL);
```

### 쓰기 최적화
```javascript
// 배치 쓰기로 성능 향상
const batchWrite = {
  RequestItems: {
    'CheckRecords': [
      { PutRequest: { Item: record1 } },
      { PutRequest: { Item: record2 } }
    ]
  }
};

// 비동기 처리로 응답 속도 향상
const asyncProcessing = {
  immediate: "체크 기록 저장",
  background: "AI 분석, 알림 발송, 통계 업데이트"
};
```

### 비용 최적화
```javascript
// On-Demand vs Provisioned 선택
const capacityMode = {
  development: "On-Demand",
  production: "Provisioned (예측 가능한 트래픽)"
};

// TTL 설정으로 자동 삭제
const ttlSettings = {
  old_records: "1년 후 자동 삭제",
  temp_data: "24시간 후 자동 삭제"
};
```

## 확장성 고려사항

### Phase 2: 일반기록형 추가
```json
// 차압 측정 기록
{
  "PK": "RECORD#2025-09-05",
  "SK": "FACILITY#pressure_001#10:00:00",
  "record_type": "pressure_measurement",
  "facility_id": "room_b_to_a",
  "measurement_value": 1.7,
  "unit": "mmH2O",
  "judgment": "qualified",
  "measured_by": "facility_user_001"
}

// 창고 점검 기록
{
  "PK": "RECORD#2025-09-05", 
  "SK": "STORAGE#warehouse_a#09:30:00",
  "record_type": "storage_inspection",
  "warehouse_id": "warehouse_a",
  "inspection_items": {...},
  "total_score": 85,
  "grade": "good",
  "pest_found": false
}
```

### Phase 3: 고도화 기능
```javascript
// 시계열 데이터 (Amazon TimeStream)
const timeSeriesData = {
  service: "Amazon TimeStream",
  use_case: "차압 트렌드, 온습도 변화",
  retention: "7일 메모리, 1년 자기 스토리지"
};

// 복잡한 분석 (Amazon Redshift)
const analyticsData = {
  service: "Amazon Redshift",
  use_case: "월간 리포트, 패턴 분석",
  data_source: "DynamoDB → S3 → Redshift"
};

// 파일 저장 (Amazon S3)
const fileStorage = {
  service: "Amazon S3",
  use_case: "사진, 문서, 백업",
  lifecycle: "30일 IA, 90일 Glacier"
};
```

## 보안 및 규정 준수

### 데이터 보호
```javascript
// 개인정보 암호화
const encryption = {
  at_rest: "DynamoDB 기본 암호화",
  in_transit: "TLS 1.2+",
  application: "민감 데이터 필드별 암호화"
};

// 접근 제어
const accessControl = {
  authentication: "AWS Cognito",
  authorization: "IAM Role 기반",
  audit: "CloudTrail 로깅"
};
```

### GMP 규정 준수
```javascript
// 데이터 무결성
const integrity = {
  immutable_records: "체크 기록 수정 불가",
  audit_trail: "모든 변경 이력 추적",
  digital_signature: "전자 서명 지원"
};

// 데이터 보존
const retention = {
  active_records: "3년 온라인 보관",
  archived_records: "7년 아카이브 보관",
  deletion_policy: "법적 요구사항 준수"
};
```

## 모니터링 및 알림

### 시스템 모니터링
```javascript
// CloudWatch 메트릭
const monitoring = {
  performance: "응답 시간, 처리량, 오류율",
  capacity: "읽기/쓰기 용량, 스토리지 사용량",
  business: "완료율, 이상 발생률, 사용자 활동"
};

// 알림 설정
const alerts = {
  critical: "시스템 장애, 데이터 손실",
  warning: "성능 저하, 용량 부족",
  info: "일일 리포트, 주간 요약"
};
```

## 개발 및 배포 전략

### 환경 분리
```javascript
const environments = {
  development: {
    database: "DynamoDB Local",
    capacity: "On-Demand",
    monitoring: "기본"
  },
  staging: {
    database: "DynamoDB (AWS)",
    capacity: "Provisioned (최소)",
    monitoring: "상세"
  },
  production: {
    database: "DynamoDB (Multi-AZ)",
    capacity: "Auto Scaling",
    monitoring: "완전"
  }
};
```

### 데이터 마이그레이션
```javascript
// 단계별 마이그레이션
const migration = {
  phase1: "기본 테이블 생성",
  phase2: "인덱스 추가",
  phase3: "데이터 이관",
  phase4: "검증 및 최적화"
};
```

---
**작성일**: 2025-09-05  
**목적**: MVP 데이터베이스 설계 아이디어 정리  
**다음 단계**: 실제 구현 시 상세 스키마 확정  
**참고**: 해커톤 시간 제약을 고려한 최소 구조 우선
